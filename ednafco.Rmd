# load libraries and data
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(readxl)

# load eDNA assessment literature data & fix formatting
e1 <- read_xlsx("data/FCO_biodiversity_data_working.xlsx", sheet = "eDNA_assessment") %>%
  filter(pdf == "y", !is.na(region))

etmp <- e1 %>% select(mammals:prokaryotes) %>% as.matrix()
etmp[etmp == "X"] <- 1 # change Xs to 1s
etmpnum <- matrix(as.numeric(etmp), ncol = ncol(etmp))
etmpnum[etmpnum > 0] <- 1 # change >1 to 1
colnames(etmpnum) <- colnames(etmp)

e <- e1 %>%
  select(-c(mammals:prokaryotes)) %>%
  bind_cols(etmpnum) %>%
  select(paperid:year, region:substrate, impact:numsamp, mammals:prokaryotes, summary, title, journal, vol, num, pages) %>%
  rowwise() %>%
  mutate(numtaxgroups = sum(c_across(mammals:prokaryotes))) %>%
  ungroup() %>%
  mutate(othervert = case_when(mammals==1|birds==1|amphibians==1|reptiles==1 ~ 1,
                               TRUE ~ 0),
         vert = case_when(mammals==1|birds==1|amphibians==1|reptiles==1|fish==1 ~ 1,
                               TRUE ~ 0),
         metazoo = case_when(mammals==1|birds==1|amphibians==1|reptiles==1|fish==1|invertebrates==1 ~ 1,
                               TRUE ~ 0),
         microbe = case_when(prokaryotes==1|protists==1|fungi==1 ~ 1,
                               TRUE ~ 0))


# load carbon offset project data & fix formatting
p1 <- read_xlsx("data/FCO_biodiversity_data_working.xlsx", sheet = "FCO_projects") %>%
  filter(!is.na(yearMR),
         yearMR != "NA")

ptmp <- p1 %>% select(mammals:prokaryotes) %>% as.matrix()
ptmp[ptmp == "X"] <- 1 # change Xs to 1s
ptmpnum <- matrix(as.numeric(ptmp), ncol = ncol(ptmp))
ptmpnum[ptmpnum > 0] <- 1 # change >1 to 1
colnames(ptmpnum) <- colnames(ptmp)

p <- p1 %>%
  select(-c(mammals:prokaryotes)) %>%
  bind_cols(ptmpnum) %>%
  rowwise() %>%
  mutate(numtaxgroups = sum(c_across(mammals:prokaryotes))) %>%
  ungroup()
```
# taxa monitored
```{r}
# format data for eDNA assessments

e.taxplot <- etmpnum %>%
  as.data.frame() %>%
  mutate(paperid = e$paperid,
         group = "eDNA assessments") %>%
  pivot_longer(cols = mammals:prokaryotes) %>% 
  group_by(group, name) %>%
  mutate(num = sum(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(name = fct_reorder(name, desc(num)))


e.taxplot %>%
  filter(value == 1) %>%
  ggplot() +
  geom_bar(aes(x = group, fill = name),
           position = position_dodge(width = 1)) +
  scale_y_continuous(breaks = c(), labels = c())

# remove uneeded objects
# rm(etmp, etmpnum)


# attempt 2
e.taxplot <- e %>%
  select(mammals:prokaryotes) %>%
  pivot_longer(cols = mammals:prokaryotes) %>% 
  mutate(group = "eDNA assessments") %>%
  group_by(group, name) %>%
  summarize(num = sum(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(name = fct_reorder(name, num),
         pct = 100*num/nrow(e)) 

taxplot <- p %>%
  select(mammals:prokaryotes) %>%
  pivot_longer(cols = mammals:prokaryotes) %>% 
  mutate(group = "FCO projects") %>%
  group_by(group, name) %>%
  summarize(num = sum(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(name = fct_reorder(name, num),
         pct = 100*num/nrow(p)) %>%
  bind_rows(e.taxplot) %>%
  mutate(groupord = c(rep(1,10),rep(2,10)),
         group = fct_reorder(group, groupord))
  
taxplot %>%
  ggplot() +
  geom_col(aes(x = pct, y = name)) +
  facet_wrap(~group) +
  labs(x = "% of projects or studies", y = "") +
  theme_bw() +
  theme(text = element_text(size = 14))
  
ggsave("figures/fig1_taxa_monitored2.png", dpi = 400, width = 6, height = 4)
```
# increasing representation of vertebrates over time?
```{r}

mod <- glm(vert ~ I(year-2012), data = e, family = "binomial")
summary(mod)

vertplot <- data.frame(
  year =  e$year,
  fit = predict(mod, type = "response"),
  lcl = plogis(predict(mod)-2*predict(mod, se.fit = T)$se.fit),
  ucl = plogis(predict(mod)+2*predict(mod, se.fit = T)$se.fit)) %>%
  distinct()

vertplot %>%
  ggplot() +
  geom_point(aes(x = year, y = 100*fit), size = 4) +
  geom_errorbar(aes(x = year, ymin = 100*lcl, ymax = 100*ucl), size = 1, width = 0) +
  scale_x_continuous(breaks = seq(2013, 2023, by = 2)) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "% of eDNA impact assessments\ninvolving vertebrates")

ggsave("figures/fig2_vert_eDNA_assess_over_time.png", dpi = 400, width = 4, height = 4)
```

# bar charts of % vertebrates and % terrestrial over time
```{r}

```




